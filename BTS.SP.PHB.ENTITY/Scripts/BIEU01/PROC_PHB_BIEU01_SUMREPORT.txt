create or replace PROCEDURE "PHB_BIEU01_SUMREPORT"
(
  MACHUONG IN NVARCHAR2,
  NAMBC IN NUMBER,
  KYBC IN NUMBER,
  DSDVQHNS IN NVARCHAR2,
  CUR OUT SYS_REFCURSOR
)IS
P_QUERY VARCHAR2(32767);
BEGIN
P_QUERY:='SELECT  BIEU01T.LOAI_CHI_TIEU,BIEU01T.MA_LOAI,BIEU01T.STT_CHI_TIEU,BIEU01D.MA_CHI_TIEU,BIEU01T.TEN_CHI_TIEU,BIEU01T.SAP_XEP,SUM(BIEU01D.QUYET_TOAN_NAM) AS QUYET_TOAN_NAM,SUM(BIEU01D.DU_TOAN_DUOC_GIAO) as DU_TOAN_DUOC_GIAO
FROM PHB_BIEU01 BIEU01
INNER JOIN PHB_BIEU01_DETAIL BIEU01D ON BIEU01D.PHB_BIEU01_REFID = BIEU01.REFID
INNER JOIN PHB_BIEU01_TEMPLATE BIEU01T ON BIEU01T.MA_CHI_TIEU = BIEU01D.MA_CHI_TIEU
INNER JOIN PHB_DM_DVQHNS DVQHNS ON DVQHNS.MA_QHNS = BIEU01.MA_QHNS
WHERE BIEU01.MA_CHUONG='||MACHUONG||' AND BIEU01.MA_QHNS IN('||DSDVQHNS||') AND BIEU01.KY_BC='||KYBC||'
GROUP BY BIEU01D.MA_CHI_TIEU,BIEU01T.TEN_CHI_TIEU,BIEU01T.STT_CHI_TIEU,BIEU01T.SAP_XEP,BIEU01T.LOAI_CHI_TIEU,BIEU01T.MA_LOAI ORDER BY BIEU01T.SAP_XEP';
DBMS_OUTPUT.PUT_LINE(P_QUERY);
OPEN CUR FOR P_QUERY;
END PHB_BIEU01_SUMREPORT;